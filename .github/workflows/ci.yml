name: CI (FastAPI • PR only)

on:
  pull_request:
    branches: [ main ]   # add others like: 'develop'
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install deps (pip)
        if: ${{ !hashFiles('poetry.lock') }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements.txt

      - name: Prepare environment file
        run: |
          # نعمل .env نضيف فيه القيم اللي Settings محتاجها (من غير .env.example)
          cat << 'EOF' > .env
          APP_NAME=FastAPI-Test
          APP_ENV=test
          APP_DEBUG=False
          APP_URL=http://localhost:8000

          # Database
          DATABASE_URL=postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db
          TEST_DATABASE_URL=postgresql+asyncpg://test_user:test_pass@localhost:5432/test_db

          # JWT (لازم تطابق أسماء الفيلدز في Settings)
          ALGORITHM=HS256
          ACCESS_SECRET_KEY=secret
          ACCESS_TOKEN_EXPIRE=900
          REFRESH_SECRET_KEY=secret
          REFRESH_TOKEN_EXPIRE=2592000
          VALIDATION_SECRET_KEY=secret
          VALIDATION_TOKEN_EXPIRE=900

          # Mail (قيم وهمية أو فاضية لو مش مستخدمة في التست)
          SMTP_HOST=localhost
          SMTP_PORT=587
          SMTP_USER=dummy
          SMTP_PASSWORD=dummy

          # Social login (dummy)
          GOOGLE_CLIENT_ID=dummy
          GOOGLE_CLIENT_SECRET=dummy
          GOOGLE_REDIRECT_URI=http://localhost
          GOOGLE_AUTH_URL=http://localhost
          GOOGLE_TOKEN_URL=http://localhost
          GOOGLE_USERINFO_URL=http://localhost

          GITHUB_CLIENT_ID=dummy
          GITHUB_CLIENT_SECRET=dummy
          GITHUB_REDIRECT_URI=http://localhost
          GITHUB_AUTHORIZE_URL=http://localhost
          GITHUB_TOKEN_URL=http://localhost
          GITHUB_USER_API=http://localhost
          GITHUB_EMAILS=http://localhost
          EOF

      - name: Run tests
        env:
          ENV: test
        run: pytest -q --maxfail=1 --disable-warnings

      - name: Upload coverage HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov
